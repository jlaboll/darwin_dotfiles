# Integration tests for darwin_dotfiles using Tart macOS VMs
# Runs on self-hosted macOS runners with Apple Silicon

name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_devtools:
        description: 'Include devtools installation tests (slower)'
        required: false
        default: 'false'
        type: boolean

# Ensure only one integration test runs at a time (VMs are resource-intensive)
concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-test:
    name: Integration Test (${{ matrix.shell }})
    # Requires a self-hosted macOS runner with Tart installed
    # GitHub-hosted macOS runners don't support nested virtualization
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        shell: [bash, zsh]
    
    env:
      TART_BASE_IMAGE: ghcr.io/cirruslabs/macos-sequoia-base:latest
      VM_USER: admin
      VM_PASS: admin
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Tart
        run: |
          # Ensure Tart is installed
          if ! command -v tart &> /dev/null; then
            brew install cirruslabs/cli/tart
          fi
          
          # Ensure sshpass is installed
          if ! command -v sshpass &> /dev/null; then
            brew install hudochenkov/sshpass/sshpass
          fi
          
          # Pull base image if not cached
          if ! tart list | grep -q "dotfiles-base"; then
            echo "Pulling base image..."
            tart clone "$TART_BASE_IMAGE" dotfiles-base
          fi
      
      - name: Run Integration Tests
        run: |
          chmod +x ./test/run-integration-tests.sh
          
          if [[ "${{ github.event.inputs.test_devtools }}" == "true" ]]; then
            ./test/run-integration-tests.sh ${{ matrix.shell }} true
          else
            ./test/run-integration-tests.sh ${{ matrix.shell }}
          fi
      
      - name: Cleanup VMs
        if: always()
        run: |
          # Clean up any lingering test VMs
          for vm in $(tart list | grep "dotfiles-test" | awk '{print $1}'); do
            echo "Cleaning up VM: $vm"
            pkill -f "tart run $vm" 2>/dev/null || true
            tart delete "$vm" 2>/dev/null || true
          done

  # Quick smoke test that doesn't require VMs
  smoke-test:
    name: Smoke Test (Syntax Check)
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check shell script syntax
        run: |
          echo "Checking shell script syntax..."
          
          # Check all .sh files
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            bash -n "$script" || exit 1
          done
          
          # Check profile files
          for profile in links/bash_profile links/bashrc links/zsh_profile links/zshrc; do
            if [[ -f "$profile" ]]; then
              echo "Checking: $profile"
              bash -n "$profile" || exit 1
            fi
          done
          
          echo "All syntax checks passed!"
      
      - name: Test shell detection function
        run: |
          source lib/core/dotfiles.sh
          
          # Test that is_shell_bash function exists and runs
          if type is_shell_bash &>/dev/null; then
            echo "✓ is_shell_bash function exists"
          else
            echo "✗ is_shell_bash function not found"
            exit 1
          fi
          
          # Run the function (shouldn't error)
          if is_shell_bash; then
            echo "✓ Default shell is bash"
          else
            echo "✓ Default shell is not bash (likely zsh)"
          fi

